<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Wolk</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="description" content="Wolk Trustless HTTP Blockchains" />
<meta name="robots" content="index, follow" />
<style>
.h { font-size: 8pt; }
.s0 { font-size: 8pt; font-family: Courier; }
.chunk { font-size: 8pt; font-family: Courier; }
#chunkID { font-family: Courier; }
.ok { background-color: #AAEEAA; }
.missing { background-color: #EEAAAA; }
.secondsago { white-space: nowrap; }
.problem {  color: red; }
.minter { background-color: #00FF00; padding: 1px; margin: 1px; border: 1px solid black;}
</style>
<script src="https://testnet.wolk.com/nodes.js"></script>
<script>
function s(b) {
  if ( b ) {
      return("<span class='ok'>OK</span>");
  } else {
      return("<span class='missing'>-</span>");
  }
}

function hexString(buffer) {
  const byteArray = new Uint8Array(buffer);

  const hexCodes = [...byteArray].map(value => {
    const hexCode = value.toString(16);
    const paddedHexCode = hexCode.padStart(2, '0');
    return paddedHexCode;
  });

  return hexCodes.join('');
}


function updatechunksearch(i, j, r, chunkID) {
    var nodenumber = r.nodenumber;
    var port = 82;
    var scheme = "https";
    var url = scheme + "://" + r.dns + ".wolk.com:" + port + "/wolk/share/" + chunkID;
    console.log(url);
    var val_id = "val-" + i + "-" + j;
    var dns = r.dns + ".wolk.com";
    fetch(url)
        .then(function(response) {
            return response.arrayBuffer();
        })
        .then(function(buff) {
          window.crypto.subtle.digest('SHA-256', buff).then(digestValue => {
            var computedID = hexString(digestValue);
            var str = "";
            if ( computedID != chunkID ) {
              str = "<div class='missing'><a href='" + url + "'>" + computedID  + "</a> (" + buff.byteLength + " bytes)</div>";
            } else {
              str = "<div class='ok'>" + buff.byteLength + " bytes</div>";
            }
            document.getElementById(val_id).innerHTML = str;
          });
        })
        .catch(function(err) {
          console.log(err);
            document.getElementById(val_id).innerHTML = "unk";
        });
}


function updatenodes() {
    var chunkIDs = document.getElementById("chunkID").value.trim().split(/\r?\n/)
    var str = "<table>";
    str += "<tr bgcolor='#EECCCC'>";
    str += "<th width=100>chunkID</th>";
    for (var j=0; j<registry.length; j++) {
         var r = registry[j];
         var publicip = r.publicip;
         var nodename = r.dns + ".wolk.com";
         if ( r.consensus > 0 ) {
           str += "<td class='hn s'>" + nodename + "</td>";
         }
    }
    str += "</tr>";
    for (var i=0; i<chunkIDs.length; i++) {
      var chunkID = chunkIDs[i].trim()
         str += "<tr><td><span class='chunk' id='chunk-" + i + "'>" + chunkID + "</span></td>";
         for (var j=0; j<registry.length; j++) {
           var r = registry[j];
           if ( r.consensus > 0 ) {
             str += "<td align='right'><span class='s0' id='val-" + i + "-" + j +"'>unk</span></td>";
           }
         }
         str += "</tr>";
    }
    str += "</table>";
    document.getElementById("chunksearchtable").innerHTML = str;

    for (var i = 0; i < chunkIDs.length; i++) {
      var chunkID = chunkIDs[i].trim()
      if ( chunkID.length >= 64 ) {
        for (var j = 0; j < registry.length; j++) {
          var r = registry[j];
          if ( r.consensus > 0 ) {
            updatechunksearch(i, j, r, chunkID);
          }
        }
      }
    }
}

</script>
</table>

</script>
<style>
.prob { color: red; }
</style>
</head>
<body onload="showtable()">
<h3>got wolk://? Cloudstore</h3>
ChunkIDs:<br/>
<textarea rows=8 cols=80 id="chunkID">
</textarea><br/>
<input type=button onClick="updatenodes();" value="Search">
<div id="chunksearchtable">
</div>
</body>
</html>

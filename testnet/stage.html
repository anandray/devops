<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Wolk</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="description" content="Wolk Trustless HTTP Blockchains" />
  <meta name="robots" content="index, follow" />
  <style>
  #blocknumber_id {
    float: right;
    background-color: #AAFFAA;
    border: 1px solid black;
    margin: 10px;
    padding: 10px;
  }
    th {
      font-size: 10pt;
    }

    .h {
      font-size: 8pt;
    }

    .hn {
      font-size: 8pt;
      text-align: right;
      white-space: nowrap;
    }

    .s0 {
      background-color: #FFEEEE;
    }

    .s1 {
      text-align: center;
      background-color: #EEFFEE;
    }

    .s2 {
      background-color: #EEEEFF;
    }

    .s3 {
      background-color: #FFEEFF;
    }

    .red {
      background-color: #FFAAAA;
      padding: 5px;
      margin: 5px;
    }

    .green {
      background-color: #AAFFAA;
      padding: 5px;
      margin: 5px;
    }

    .final {
      padding: 5px;
      margin: 5px;
      border: 3px solid black;
    }

    .orphan {
      padding: 5px;
      margin: 5px;
      border: 4px solid red;
    }

    .tentative {
      padding: 5px;
      margin: 5px;
      border: 1px dashed black;
    }

.cluster { background-color: #AAFFAA; padding: 1px; margin: 1px; border: 1px solid black; font-size: 13pt; }
        .notfound {
          padding: 5px;
          margin: 5px;
          border: 1px dashed grey;
        }

        .empty {
          padding: 5px;
          margin: 5px;
          border: 3px dashed red;
        }


    .infosum {
      float: left;
      background: #FFAAAA;
      margin: 2px;
    }

    .networkid {
      float: left;
      background: #FFEEFF;
      margin: 2px;
    }

    .storage {
      background-color: #EEEEEE;
    }

    .secondsago {
      white-space: nowrap;
    }

    .problem {
      color: red;
    }

    .proposer {
      background-color: #00FF00;
      padding: 1px;
      margin: 1px;
      border: 1px solid black;
    }
  </style>
  <script src="nodes.js"></script>
  <script>
  var activePort = 81;
  var currentstage = 1;
  var maxblocknumber = 1;
    function resetgc(hostname, project, zone) {
      var gctxt = "gcloud compute instances reset " + hostname + " --project " + project + " --zone " + zone;
      var result = copyToClipboard(gctxt);
      alert("Command Copied to Clipboard:\n" + gctxt);
      return true;
    }

    function resetaws(instanceid, region) {
      var awstxt = "aws ec2 reboot-instances --instance-ids " + instanceid + " --region " + region;
      var result = copyToClipboard(awstxt);
      alert("Command Copied to Clipboard:\n" + awstxt);
      return true;
    }

    function resetalibaba(instanceid, region) {
      var alibabatxt = "aliyuncli ecs RebootInstance --RegionId " + region + " --InstanceId " + instanceid;
      var result = copyToClipboard(alibabatxt);
      alert("Command Copied to Clipboard:\n" + alibabatxt);
      return true;
    }

    function resetazure(instanceid, region) {
      var azuretxt = "az vm restart -g " + region + " --ids" + instanceid;
      var result = copyToClipboard(azure);
      alert("Command Copied to Clipboard:\n" + azuretxt);
      return true;
    }

    function copySSH(hostname) {
      var sshtxt = "ssh root@" + hostname;
      var result = copyToClipboard(sshtxt);
      return true;
    }

    function copyToClipboard(text) {
        if (window.clipboardData && window.clipboardData.setData) {
            // IE specific code path to prevent textarea being shown while dialog is visible.
            return clipboardData.setData("Text", text);
        } else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
            var textarea = document.createElement("textarea");
            textarea.textContent = text;
            textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in MS Edge.
            document.body.appendChild(textarea);
            textarea.select();
            try {
                return document.execCommand("copy");  // Security exception may be thrown by some browsers.
            } catch (ex) {
                console.warn("Copy to clipboard failed.", ex);
                return false;
            } finally {
                document.body.removeChild(textarea);
            }
        }
    }

    function reset(j) {
      var n = registry[j];
      if (n.cloudprovider == "gc") {
        return resetgc(n.hostname, n.project, n.datacenter);
      }
      if (n.cloudprovider == "aws") {
        return resetaws(n.id, n.datacenter);
      }
      if (n.cloudprovider == "alibaba") {
        return resetalibaba(n.id, n.datacenter);
      }
      if (n.cloudprovider == "azure") {
        return resetazure(n.id, n.datacenter);
      }
      alert("Not implemented")
    }

    function terminate() {
      var n = registry[j];
      if (n.cloudprovider == "gc") {
        return terminategc(n.id, n.project, n.datacenter);
      }
      if (n.cloudprovider == "aws") {
        return terminateaws(n.id, n.datacenter);
      }
      if (n.cloudprovider == "alibaba") {
        return terminatealibaba(n.id, n.datacenter);
      }
      if (n.cloudprovider == "azure") {
        return terminateazure(n.id, n.datacenter);
      }
      alert("Not implemented")
    }


    function terminategc(hostname, project, zone) {
      alert("gcloud -q compute instances delete " + hostname + " --zone=" + zone + " --project " + project);
      return true;
    }

    function terminateaws(instanceid, region) {
      alert("aws ec2 terminate-instances --instance-ids " + instanceid + " --region " + region);
      return true;
    }

    function terminateazure(instanceid, region) {
      alert("not implemented"); // TODO
      return true;
    }

    function terminatealibaba(instanceid, region) {
      alert("not implemented"); // TODO
      return true;
    }

    function getlatest() {
      console.log("getlatest", activePort)
      for (var i = 0; i < registry.length; i++) {
        updateinfo(i, registry[i]);
      }
    }

    function bytes_to_mb(b) {
      return (b / (1024 * 1024)).toFixed(0) + "MB";
    }

    function getBlockchainInfo() {
      var port = 443;
      var scheme = "https";
      var info = {
        port: port,
        explorerURL: scheme + "://c0.wolk.com:" + port + "/app/explorer/home.html"
      }
      return info
    }

    var domain = "wolk.com";

    var parseQueryString = function() {
	  var str = window.location.search;
	  var objURL = {};
	  str.replace(
	    new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
	    function( $0, $1, $2, $3 ){
            	objURL[ $1 ] = $3;
	    }
    	);
       return objURL;
    };

    function loadDefaultStage() {
    	var params = parseQueryString();
    	var defaultstage = params["stage"] ;
    	if ( defaultstage == null){
    	    return updateregistry(1);
    	}else{
    	    return updateregistry(parseInt(defaultstage));
    	}
    }

    function updateregistry(stage) {
      currentstage = stage;
      maxblocknumber = 1;
      activePort = 80 + stage;
      if ( activePort == 80 ) {
	       activePort = 443;
      }
      showstagelist();
      testnet()
      updatestages();
    }
    function int_to_yn(i) {
      return( i > 0 ? "YES" : "NO");
    }

    function isvoting(dns, isvoting) {
      url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/isvoting/" + isvoting;
      fetch(url);
    }
    function ismalicious(dns, ismalicious) {
      var url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/malicious/" + ismalicious;
      fetch(url);
    }
    function networklatency(dns, latency) {
      var url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/latency/" + latency;
      fetch(url);
    }

    function setisvoting(dns, isvoting) {
      url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/isvoting/" + isvoting;
      fetch(url);
      return url;
    }
    function setismalicious(dns, ismalicious) {
      var latency = 5+Math.floor(Math.random() * 5);
      var url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/latency/" + latency;
      fetch(url);
      return url;
    }
    function setnetworklatency(dns, latency) {
      var url = "https://" + dns + "." + domain + ":" + activePort + "/wolk/latency/" + latency;
      fetch(url);
      return url;
    }

    function updateinfo(i, r) {
      var params = parseQueryString();
      var defaultstage = params["stage"] ;
      if ( defaultstage == null ) {
        var stage = 1
      }else{
        var stage = parseInt(defaultstage);
      }

      var scheme = "https";
      var url = scheme + "://" + r.dns + "." + domain + ":" + activePort + "/wolk/info";
      if ( r.knode > 0 ) {
         var altport = 80 + 1000 * stage + i;
         url = scheme + "://" + r.dns + "-" + stage + "." + domain + ":" + altport + "/wolk/info";
         console.log(url);
      }

      var bl_id = "bl-" + i;
      var lfr_id = "lfr-" + i;
      var cs_id = "cs-" + i;
      var isv_id = "isv-" + i;
      var mal_id = "mal-" + i;
      var lat_id = "lat-" + i;
      var step_id = "step-" + i;

      var ev_id = "ev-" + i;
      var tw_id = "tw-" + i;
      var peers_id = "peers-" + i;
      var mem_id = "mem-" + i;
      var cache_id = "cache-" + i;
      var gor_id = "gor-" + i;
      var buildinfosum_id = "bis-" + i;
      var consensus_id = "con-" + i;
      var networkid_id = "networkid-" + i;
      var knode = r.knode;
      var dns = r.dns + "." + domain;
      var options = {
        mode: 'no-cors'
      };
      fetch(url)
        .then(function(response) {
          return response.json();
        })
        .then(function(info) {
          if (info.peers != undefined) {
            document.getElementById(peers_id).innerHTML = info.peers;
          }
          var base = scheme + "://" + dns + ":" + activePort
	         if ( knode > 0 ) {
              var altport = 80 + 1000 * stage + i;
              url = scheme + "://" + dns + "-" + stage + "." + domain + ":" + altport + "/wolk/info";
          }

          var str = "";
          var restart = false;
          if (info.blockNumber != undefined) {
            var certurl = base + "/wolk/cert/" + info.blockNumber;
            if ( ( i == 0 ) ||  ( info.blockNumber > maxblocknumber )  ) {
              maxblocknumber = info.blockNumber;
            }
            str = "<a href='" + certurl + "' target='_new'>" + info.blockNumber + "</a>";
            if (info.isPreemptive != undefined) {
              str += "<BR>" + (info.isPreemptive ? "preemptive" : "")
            }
            if (info.lastBlockMintedSecondsAgo != undefined) {
              if (info.lastBlockMintedSecondsAgo > 60) {
                if (info.lastBlockMintedSecondsAgo > 999) {
                  info.lastBlockMintedSecondsAgo = 999;
                }
                restart = true;
                cl = "problem";
                str += "<BR><span class='secondsago " + cl + "'>" + info.lastBlockMintedSecondsAgo + " secs ago</span>"
              } else {
                cl = "";
                str += "<BR><span class='secondsago'>" + info.lastBlockMintedSecondsAgo + " secs ago</span>"
              }
              if (info.isProposer != undefined) {
                if (info.isProposer) {
                  str += "&nbsp;<span class='proposer'><B>Proposer</B></span>";
                }
              }
            }
            document.getElementById(bl_id).innerHTML = str;
          }
	  if ( info.lastFinalizedRound != undefined ) {
            var bgc = "FFFFFF";
	    var tentativeLen = 999;
	    var blkclass = "orphan";
	    var blkstr = "<sup>"+ " -" + "</sup>";
            if ( info.lastFinalizedHash != undefined ){
	       blkclass = "final";
	       tentativeLen = info.blockNumber - info.lastFinalizedRound;
	       if (tentativeLen > 0) {
                   blkclass = "tentative";
		   blkstr = "<sup>"+ " +" +tentativeLen + "</sup>";
	       }
               bgc = info.lastFinalizedHash.substring(2, 10);
            }

            var certurl = base + "/wolk/cert/" + info.lastFinalizedRound;
	    innerHTMLstr = "<span class='" + blkclass + "' style='background: #" + bgc +  "'><code><a href='" + certurl + "' target='_new'>" + info.lastFinalizedRound + "</a>" + blkstr + "</code></span>";
            document.getElementById(lfr_id).innerHTML = innerHTMLstr;
	  }
          if (info.consensusStatus != undefined) {
            var str = info.consensusStatus;
            if (info.consensusStatusUpdatedSecondsAgo != undefined) {
              if (info.consensusStatusUpdatedSecondsAgo > 20) {
                cl = "problem";
              } else {
                cl = "";
              }
              str += "<BR><span class=' " + cl + "'>" + info.consensusStatusUpdatedSecondsAgo + " secs ago</span>"
            }
            document.getElementById(cs_id).innerHTML = str;
          }
          if (restart) {
            str += "&nbsp;<a href='javascript:restartbin(\"" + dns + "\")'>restart</a>";
          }
          if (info.alloc != undefined) {
            var strm = "Alloc:" + bytes_to_mb(info.alloc) + "<BR>Sys:" + bytes_to_mb(info.sys);
            if (info.numConnections != undefined) {
              strm += "<BR>NumConn:" + info.numConnections;
            }
            document.getElementById(mem_id).innerHTML = strm;
          }

          if (info.expectedTentative != undefined  && info.expectedFinal != undefined ) {
            cstr = "<h3>" + info.expectedTentative + " / " + info.expectedFinal + "</h3>"
            document.getElementById(ev_id).innerHTML = cstr;
          }

          if (info.tokenWeight != undefined ) {
            cstr = "<h3>" + info.tokenWeight + "</h3>"
            document.getElementById(tw_id).innerHTML = cstr;
          }
          if (info.step != undefined) {
            cstr = "<code>" + step_to_string(info.step) + "</code>"
            document.getElementById(step_id).innerHTML = cstr;
          }

          if (info.certs != undefined) {
            var bn = info.blockNumber;
            var covered = [ false, false, false, false, false, false, false, false, false, false ];
	    var prevHash = "";

            for (var c = 0; c < info.certs.length; c++) {
              var certstr = "";
              var cert = info.certs[info.certs.length - 1 - c];
              var cbn = cert.BlockNumber;
              var diff = (maxblocknumber - cbn);
	      var link = "";
              certclass = "red";
              if ((diff >= 0) && (diff < 10)) {
		var cert_id = "cert-" + diff + "-" + i;

                if (cert.CountVotes >= info.expectedFinal) {
                  certclass = "final";
                } else {
                  certclass = "tentative";
                }

		if ( cert.BlockHash == prevHash ) {
		  link = "--";
		} else if ( diff > 0 ) {
		  link = "🔧";
		  certclass = "orphan";
	        }
		prevHash = cert.ParentHash;

                var cv = ( cert.CountVotes != undefined ) ? cert.CountVotes : "";
                certstr += "<sub>" + cv + "</sub>";
		if ( cert.Empty != undefined && cert.Empty ) {
		     certclass = "empty";
		     certstr += "<sup>e</sup>";
		}
		var elem = document.getElementById(cert_id)
                if (elem != undefined && certclass != "red") {
                  var bgc = "FFFFFF";
                  if ( cert.BlockHash != undefined ) {
		      bgc = cert.BlockHash.substring(2, 10);
		  }
		  var u = base + "/wolk/cert/" + cert.BlockNumber;
                  elem.innerHTML = link + "<span class='" + certclass  + "' style='background: #" + bgc +  "'><code><a href='" + u + "' target='_new'>" + cert.BlockNumber + "</a>" + certstr + "</code></span>";
		  covered[diff] = true;
                }
              }
            }

	    for ( var diff = 0 ; diff < 10; diff++ ) {
		 if ( covered[diff] == false ) {
			  var cert_id = "cert-" + diff + "-" + i;
				    var elem = document.getElementById(cert_id)
				    elem.innerHTML = "";
		 }
    	    }


          }

          if (info.numGoroutine != undefined) {
            var pprofurl = base + "/pprof/goroutine/2"
            document.getElementById(gor_id).innerHTML = "<a href='" + pprofurl + "'>" + info.numGoroutine + "</a>";
          }
          if (info.chunkCacheSize != undefined) {
            var str = "StateDB:" + info.stateDBCacheSize;
            if (info.pendingTxCount != undefined) {
              str += "<BR>PendingTX: <a href='" + base + "/wolk/txpool'>" + info.pendingTxCount + "</a>";
            }
            document.getElementById(cache_id).innerHTML = str;
          }
          if (info.buildInfoSum != undefined) {
            var sum = info.buildInfoSum;
            if (sum.length > 4) {
              sum = sum.substr(0, 4);
            }
            document.getElementById(buildinfosum_id).innerHTML = "<code><span style='background: #" + sum + "'>" + sum + "</span></code>";
          }
          if (info.networkID != undefined) {
            var networkID = info.networkID % 10000;
            document.getElementById(networkid_id).innerHTML = "<code><span style='background: #CC" + networkID + "'>" + networkID + "</span></code>";
          }
        })
        .catch(function(err) {
          document.getElementById(peers_id).innerHTML = "<a href='javascript:restartbin(\"" + dns + "\")'>unk</a>";
			    console.log(err)
        });
    }

    function restartbin(dns) {
      alert("restartwolk " + dns + " " + currentstage);
    }

    function updatestages() {
      document.getElementById("testnettable").innerHTML = testnet();
      getlatest();
    }

    var ncerts = 10;
    function testnet() {
      var str = "<table width='100%'>";
      str += "<tr bgcolor='#EECCCC'>";
      str += "<th width=150>Cloudstore Host</th>";
      str += "<th width=50>Node</th>";
      str += "<th width=100>Public IP</th>";
      str += "<th width=75><a href='javascript:getlatest();'>BN</a></th>";

      str += "<th width=50>LFR</th>";
      str += "<th width=275>Status</th>";
      str += "<th width=100>Step</th>";

      str += "<th width=80>Exp#</th>";
      str += "<th width=60>Tokens</th>";
      for (var i = 0; i < ncerts; i++) {
        str += "<th width=10>C" + i + "</th>";
      }
      str += "<th width=75>Bld/Peers</th>";
      str += "<th width=75>Mem</th>";
      str += "<th width=75>NID/GoR</th>";
      str += "<th width=75>Cache</th>";
      str += "</tr>";
      for (var j = 0; j < registry.length; j++) {
        var r = registry[j];
        var publicip = r.publicip;
        var nodename = r.dns + "." + domain;
        var cl = "storage";
        if (r.consensus > 0) {
          cl = "consensus";
        }
	var nodeName = nodename
        var infourl = "https://" + nodename + ":" + activePort + "/wolk/info";
        var consensusurl = "https://" + nodename + ":" + activePort + "/wolk/consensus";
        str += "<tr class='h " + cl + "'>";
	var sshcmd = "javascript:copySSH(\'" + nodename + "\');";
        str += "<td class='h'><a href='" + infourl + "' target='_new'>" + nodename + "</a><span style='float:right'><a href='javascript:reset(" + j + ");'>reset</a>&nbsp;<a href=\"" + sshcmd + "\">ssh</a>&nbsp;</span>";
        str += "</td>";
        str += "<td class='h'><span class='cluster'>" + r.cluster + "</span></td><td><code>" + publicip + "</code>";
        str += "<div></div>";
        str += "<div>" + r.datacenter + "</div>";
        str += "</td>";
        var i = 0;

        str += "<td class='hn s0'><span id='bl-" + j + "'></span></td>";

        str += "<td class='hn s0'><span id='lfr-" + j + "'></span></td>";
        str += "<td class='hn s0'><span id='cs-" + j + "'></span></td>";
        str += "<td class='hn s0'><span id='step-" + j + "'></span></td>";

        str += "<td class='hn s0'><span id='ev-" + j + "'></span></td>";
        str += "<td class='hn s0'><span id='tw-" + j + "'></span></td>";
        for (var c = 0; c < ncerts; c++) {
          str += "<td class='hn s0'><span id='cert-" + c + "-" + j + "'></span></td>";
        }
        str += "<td class='hn s0'><span id='peers-" + j + "'>0</span><div class='infosum' id='bis-" + j + "'></div></td>";
        str += "<td class='hn s0'><span id='mem-" + j + "'></span></td>";
        str += "<td class='hn s0'><span class='networkid' id='networkid-" + j + "'></span><span id='gor-" + j + "'></span></td>";
        str += "<td class='hn s0'><span id='cache-" + j + "'></span></td>";
        str += "</tr>";
      }
      str += "</table>";
      return str;
    }

    function getround() {
      return maxblocknumber;
    }

    function step_to_string(step) {
       switch ( step ) {
       case 0: return "Proposal";
       case 1: return "Reduction";
       case 2: return "Soft";
       case 3: return "Cert";
       case 4: return "Next";
       case 6: return "Empty";
       }
       return s;
    }
    function refreshDisplay() {
      setTimeout(function() {
        getlatest();
        document.getElementById('blocknumber_id').innerHTML = "<font size='+3'>" + maxblocknumber + "</font>";
        refreshDisplay();
      }, 2500);
    }
    refreshDisplay();

function showstagelist() {
  var str = "[";
  for (var i = 0; i <= 4; i++) {
      if ( i > 0 ) {
        str += "&nbsp;|&nbsp;";
      }
      if ( i == currentstage ) {
	   str += "<B>stage " + i + "</B>";
      } else {
	   str += "<a href='stage.html?stage=" + i + "'>stage " + i + "</a>";
      }
  }
  str += "]";
  document.getElementById("stagelist").innerHTML = str;
}
</script>
  </table>
  <style>
    .prob {
      color: red;
    }
  </style>
</head>
<body onload="loadDefaultStage()">
  <span id="blocknumber_id"></span>
  <h3>got wolk://? Testnets</h3><div id='stagelist'></div>
  <div id="testnettable"></div>
</body>
</html>

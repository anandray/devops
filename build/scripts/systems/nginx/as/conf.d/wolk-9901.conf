server {
    listen       172.31.21.222:80;
    server_name  cloudflare.wolk.com cloudstore-as.wolk.com;

    #charset koi8-r;
#    access_log  /var/log/nginx/host.access.log  main;
error_log  /var/log/nginx/wolk-error.log warn;
error_log  /var/log/nginx/wolk-error-crit.log crit;
error_log  /var/log/nginx/wolk-error-debug.log debug;

    location /wolkhealthcheck {
        root   /usr/share/nginx/html;
        index  ok.txt index.html index.htm;
    }

#    keepalive_timeout       3000;
#    keepalive_requests      20000;

    client_body_timeout 1000;
    client_header_timeout 1000;
    keepalive_timeout 3000;
    send_timeout 300;
    keepalive_requests 20000;

#    client_body_timeout 1m;
#    client_header_timeout 1m;
#    keepalive_timeout 65;
#    send_timeout 30s;
#    keepalive_requests 3000;

    client_max_body_size 12m;
    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

        location /{
                proxy_pass  http://wolk-9901;
                ### force timeouts if one of backend is died ##
                proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;

                proxy_connect_timeout   180;
                proxy_send_timeout      180;
                proxy_read_timeout      180;
                send_timeout            180;

		
    proxy_ignore_client_abort on;
    proxy_max_temp_file_size 0;
    proxy_buffering off;

                ### Set headers ####
#               proxy_set_header Host $host; ###$host changed to $http_host in the next line
                proxy_set_header Host $http_host; ###ADD THIS LINE
#                proxy_connect_timeout 3; ###ADD THIS LINE
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto https;

                ### By default we don't want to redirect it ####
                proxy_redirect     off;
		client_max_body_size 12m;
         }

        location ~* ^.+.(jpg|jpeg|gif|png|css)$ {
             proxy_cache_valid 200 301 302 120m;
             expires 1d;
             proxy_pass http://wolk-9901;
#             proxy_cache one;
        }
                ###ADD the following 3 lines###
                set $filename $request_uri;
                if ($request_uri ~* ".*/(.*)") {
                set $filename $1;
        }

}


#!/usr/bin/php
<?php
include_once "storage.php";
include_once "supernode.php";

error_reporting(E_ERROR);

function get_servers($range = "all") 
{
  if ( $range == "all" ) {
    $sql = "select hostname, publicip, datacenter, cloudprovider, consensus, nodenumber, dns from servers where pushwolk=1 order by consensus desc, nodenumber";
  } else if ( ctype_digit($range) ) {
    $sql = "select hostname, publicip, datacenter, cloudprovider, consensus, nodenumber, dns from servers where nodenumber = '$range' order by consensus desc";
  } else {
    $sql = "select hostname, publicip, datacenter, cloudprovider, consensus, nodenumber, dns from servers where ( dns = '$range' or publicip = '$range' or cloudprovider = '$range' ) order by consensus desc, nodenumber";
  }
  if ( $res = mysql_query($sql) ) {
    while ( $a = mysql_fetch_object($res) ) {
      $servers[] = $a;
    }
  } else {
    echo mysql_error();
    exit(0);
  }
  return($servers);
}

if ( $argc < 2 ) {
   echo "Manual: (useful for testing new supernodes, not required to be be in servers table)\n";
   echo "   nodecheck [serverip] [cloudprovider=gc|aws|azure|alibaba] [nodeType=consensus|storage] (publicip)\n";
   echo "Automatic: (useful for verifying supernodes in production, must be in servers table)\n";
   echo "   nodecheck [serverip|all|cx|nodenumber]\n";
   echo "   nodecheck all -- runs checks on all servers\n";
   echo "   nodecheck 3   -- runs checks on node 3 [consensus + storage]\n";
   echo "   nodecheck c2  -- runs checks on c2.wolk.com (must be in servers table)\n";
   echo "   nodecheck 52.67.124.96 -- runs checks on specific ip 52.67.124.96\n";
   echo "   nodecheck azure -- runs checks on all azure nodes\n";
   echo "Checks:\n";
   echo " - toml presence\n";
   echo " - storage credentials presence\n";
   echo " - ssl files presence\n";
   echo " - nodeType consistency [consensus/storage]\n";
   echo " - wolk binary presence\n";
   exit(0);
}

getWolkDatabase(true);

$server = $argv[1];
if ( ! isset($argv[2]) ) {
   echo "nodecheck @ ".date("Y-m-d H:i:s", time())."\n";
  $servers = get_servers($server); 
  foreach ($servers as $s) {
    $servername = $s->dns.".wolk.com";
    $nodeType = ( $s->consensus > 0 ) ? "consensus" : "storage";
    check_toml($servername, $s->cloudprovider, $nodeType, $s->publicip); 
  }
} else {
  $cloudprovider = isset($argv[2]) ? $argv[2] : "gc";
  $nodeType = isset($argv[3]) ? $argv[3] : "consensus";
  $publicip = isset($argv[4]) ? $argv[4] : "";
  echo "running nodecheck [server=$server, cloudprovider=$cloudprovider] ... \n";
  check_toml($server, $cloudprovider, $nodeType, $publicip);
}
?>

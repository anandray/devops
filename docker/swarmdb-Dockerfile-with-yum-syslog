FROM centos

COPY sbin/main /usr/bin/main
COPY scripts/swarmdb /etc/init.d/swarmdb
COPY scripts/swarmdb.service /usr/lib/systemd/system/swarmdb.service
COPY scripts/swarmdb-start.sh /swarmdb/bin
COPY swarmdb /swarmdb

COPY scripts/swarmdb-start.sh /swarmdb/scripts/swarmdb-start.sh
COPY scripts/swarmdb-start-crontab.sh /swarmdb/scripts/swarmdb-start-crontab.sh
COPY scripts/syslog-ng-start.sh /swarmdb/scripts/syslog-ng-start.sh
COPY scripts/syslog-ng-start-crontab.sh /swarmdb/scripts/syslog-ng-start-crontab.sh

RUN systemctl enable swarmdb.service

RUN unlink /etc/localtime
RUN ln -s /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
RUN yum -y install crontabs epel-release initscripts iproute mlocate net-tools sudo telnet vim wget which git

# installing syslog-ng
RUN rpm -Uvh https://dl.iuscommunity.org/pub/ius/stable/Redhat/7/x86_64/ius-release-1.0-15.ius.el7.noarch.rpm
RUN yum -y install syslog-ng syslog-ng-libdbi libdbi-devel 

# adding syslog config to /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "# start swarm syslogging" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "filter f_log6 { match(\"wolk-debug\" value(\"PROGRAM\")) or match(\"wolk-trace\" value(\"PROGRAM\")) or match(\"wolk-cloud\" value(\"PROGRAM\")) or match(\"wolk-mining\" value(\"PROGRAM\")) or match(\"wolk-mining\" value(\"PROGRAM\")) or match(\"wolk-tcp\" value(\"PROGRAM\")) or match(\"wolk-http\" value(\"PROGRAM\")); };" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "destination log6 {tcp(\"log6\" port (5000));};" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "log { source(s_sys); filter(f_log6); destination(log6); };" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "" >> /etc/syslog-ng/conf.d/swarm-syslog.conf
RUN echo "# /end swarm syslogging" >> /etc/syslog-ng/conf.d/swarm-syslog.conf

#RUN sed -i 's/system/#system/g' /etc/syslog-ng/syslog-ng.conf
RUN sed -i -E 's/^(\s*)system\(\);/\1unix-stream("\/dev\/log");/' /etc/syslog-ng/syslog-ng.conf
RUN sed -i 's/udp/#udp/g' /etc/syslog-ng/syslog-ng.conf
RUN sed -i '29 i\    tcp(ip(0.0.0.0) port(5000));' /etc/syslog-ng/syslog-ng.conf
RUN /usr/sbin/chkconfig syslog-ng on
#RUN /usr/sbin/syslog-ng -F -p /var/run/syslogd.pid &
RUN echo "alias vi='/usr/bin/vim'" >> ~/.bashrc
RUN echo "" >> ~/.bashrc

RUN echo "if ifconfig eth0 &> /dev/null; then" >> ~/.bashrc
RUN echo "ip=`ifconfig eth0 | grep inet | awk '{print$2}' | cut -d ":" -f2 | head -n1`" >> ~/.bashrc
RUN echo "fi" >> ~/.bashrc
RUN echo "" >> ~/.bashrc

RUN echo "set -o ignoreeof" >> ~/.bashrc

ENTRYPOINT "/usr/bin/main &" ; "crond" ; /bin/bash
